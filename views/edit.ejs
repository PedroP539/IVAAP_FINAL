<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVAAP - Editar Planta</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            font-family: 'Quicksand', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column
        }

        .sticky-nav {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: white
        }

        .content {
            padding: 2rem 0;
            flex: 1
        }

        .edit-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            padding: 2.5rem;
            overflow: hidden
        }

        .preview-img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .2);
            margin: 1rem 0;
            transition: opacity .4s
        }

        .form-control,
        .form-check-input {
            border-radius: 12px
        }

        .form-group label {
            font-weight: bold;
            color: #27ae60
        }

        .btn-save {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border-radius: 50px;
            transition: .3s
        }

        .btn-save:hover {
            transform: scale(1.05)
        }

        .btn-save:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none
        }

        .btn-cancel {
            background: #95a5a6;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border-radius: 50px
        }

        .drop-zone {
            border: 3px dashed #27ae60;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            background: #f8fff8;
            transition: all .3s;
            cursor: pointer;
            margin-bottom: 1rem;
            height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center
        }

        .drop-zone.dragover {
            background: #e8f5e9;
            border-color: #2ecc71
        }

        .marca-section {
            background: #f0f8f0;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #d0e8d2
        }

        .marca-title {
            font-weight: bold;
            color: #27ae60;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            text-align: center
        }

        textarea {
            min-height: 200px;
        }

        .shutterstock-group {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 12px
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            color: white;
            font-size: 1.7rem;
            text-align: center;
        }

        .spinner {
            border: 10px solid #f3f3f3;
            border-top: 10px solid #27ae60;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .marca-section {
                margin-bottom: 2rem;
            }
        }
    </style>
</head>

<body>
    <header class="fixed-top">
        <div class="bg-success text-white text-center py-3">
            <% if (user) { %>
                <strong>Olá <%= user.nome %>
                        <%= user.apelido || '' %></strong>
                — último login: <%= new Date().toLocaleString('pt-PT', {day:'2-digit', month:'2-digit', year:'numeric',
                    hour:'2-digit', minute:'2-digit'}) %>
                    <% } else { %>
                        <strong>Bem-vindo ao IVAAP</strong>
                        <% } %>
        </div>
        <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
            <a class="navbar-brand font-weight-bold" href="/">IVAAP</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item"><a class="nav-link" href="/upload"><i class="fa-solid fa-upload"></i>
                            CARREGAR</a></li>
                    <li class="nav-item"><a class="nav-link" href="/review"><i class="fa-solid fa-pencil"></i> REVER</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/approved"><i class="fa-solid fa-thumbs-up"></i>
                            APROVADAS</a></li>
                    <li class="nav-item"><a class="nav-link" href="/rejected"><i class="fa-solid fa-thumbs-down"></i>
                            REJEITADAS</a></li>
                    <li class="nav-item"><a class="nav-link" href="/statistics"><i class="fa-solid fa-bolt"></i>
                            ESTATÍSTICAS</a></li>
                    <li class="nav-item"><a class="nav-link" href="/logout"><i
                                class="fa-solid fa-right-from-bracket"></i> SAIR</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <br><br><br><br>
    <main class="container content">
        <div class="text-center mb-4">
            <h2 style="color:#27ae60;font-weight:bold">EDITAR PLANTA</h2>
        </div>
        <% if (error) { %>
            <div class="alert alert-danger text-center">
                <%= error %>
            </div>
            <% } %>
                <% if (success) { %>
                    <div class="alert alert-success text-center">
                        <%= success %>
                    </div>
                    <% } %>
                        <div class="edit-card">
                            <form action="/edit" method="POST" enctype="multipart/form-data" id="editForm">
                                <input type="hidden" name="originalId" value="<%= image.id %>">
                                <div class="row">
                                    <% for(let index=0; index < 3; index++) { %>
                                        <% const related=relatedImages.find(r=> r.marca_id === index + 1) || {}; %>
                                            <div class="col-md-4">
                                                <div class="marca-section">
                                                    <h4 class="marca-title">IMAGEM <%= index + 1 %>
                                                            <% if (related.marca_nome) { %>(<%= related.marca_nome %>)<%
                                                                        } %>
                                                    </h4>
                                                    <div class="text-center">
                                                        <% if (related.image_url) { %>
                                                            <img src="/uploads/<%= related.image_url %>"
                                                                class="preview-img" style="display:block;"
                                                                alt="Imagem atual">
                                                            <p class="text-muted small mt-2">Imagem atual (ID: <%=
                                                                    related.id %>)</p>
                                                            <% } else { %>
                                                                <div class="drop-zone">
                                                                    <i class="fas fa-image fa-4x text-muted mb-3"></i>
                                                                    <p>Sem imagem nesta marca</p>
                                                                </div>
                                                                <% } %>
                                                    </div>
                                                    <div class="form-group mt-3">
                                                        <label>Nova imagem (opcional)</label>
                                                        <input type="file" name="newImage<%= index %>"
                                                            class="form-control" accept="image/*">
                                                    </div>
                                                    <input type="hidden" name="existingImageId<%= index %>"
                                                        value="<%= related.id || '' %>">
                                                </div>
                                            </div>
                                            <% } %>
                                </div>
                                <hr class="my-5">
                                <div class="form-group">
                                    <label for="gama_id">Gama</label>
                                    <select name="gama_id" id="gama_id" class="form-control">
                                        <option value="">Nenhuma / Não definido</option>
                                        <% gamas.forEach(gama=> { %>
                                            <option value="<%= gama.id %>" <%=image.gama_id==gama.id ? 'selected' : ''
                                                %>><%= gama.nome %>
                                            </option>
                                            <% }); %>
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Espécie *</label>
                                            <input type="text" name="species" class="form-control"
                                                value="<%= image.species %>" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Variedade</label>
                                            <input type="text" name="variety" class="form-control"
                                                value="<%= image.variety || '' %>">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Nome Botânico</label>
                                    <input type="text" name="botanical_name" class="form-control"
                                        value="<%= image.botanical_name || '' %>">
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group"><label>Origem</label><input type="text" name="origem"
                                                class="form-control" value="<%= image.origem || '' %>"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group"><label>Colheita/Floração</label><input type="text"
                                                name="colheitaFloracao" class="form-control"
                                                value="<%= image.colheitaFloracao || '' %>"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group"><label>Exposição Solar</label><input type="text"
                                                name="exposicaoSolar" class="form-control"
                                                value="<%= image.exposicaoSolar || '' %>"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group"><label>Rega</label><input type="text" name="rega"
                                                class="form-control" value="<%= image.rega || '' %>"></div>
                                    </div>
                                </div>
                                <div class="form-group"><label>Profundidade Sementeira</label><input type="text"
                                        name="profundidadeSementeira" class="form-control"
                                        value="<%= image.profundidadeSementeira || '' %>"></div>
                                <div class="form-group"><label>Sementeira Direta</label>
                                    <div class="form-check"><input class="form-check-input" type="checkbox"
                                            name="sementeiraDireta" <%=image.sementeiraDireta ? 'checked' : '' %>><label
                                            class="form-check-label">Sim</label></div>
                                </div>
                                <div class="form-group"><label>Sementeira Alfobre</label>
                                    <div class="form-check"><input class="form-check-input" type="checkbox"
                                            name="sementeiraAlfobre" <%=image.sementeiraAlfobre ? 'checked' : ''
                                            %>><label class="form-check-label">Sim</label></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group"><label>Sementeira (mês)</label><input type="text"
                                                name="sementeira" class="form-control"
                                                value="<%= image.sementeira || '' %>"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group"><label>Transplante (mês)</label><input type="text"
                                                name="transplante" class="form-control"
                                                value="<%= image.transplante || '' %>"></div>
                                    </div>
                                </div>
                                <div class="form-group"><label>Compasso</label><input type="text" name="compasso"
                                        class="form-control" value="<%= image.compasso || '' %>"></div>
                                <div class="form-group"><label>Características</label><textarea name="caracteristicas"
                                        class="form-control" rows="3"><%= image.caracteristicas || '' %></textarea>
                                </div>
                                <div class="form-group"><label>Conselhos de Cultivo</label><textarea
                                        name="conselhos_de_cultivo" class="form-control"
                                        rows="4"><%= image.conselhos_de_cultivo || '' %></textarea></div>
                                <div class="form-group"><label>Comentários</label><textarea name="comentarios"
                                        class="form-control" rows="3"><%= image.comentarios || '' %></textarea></div>
                                <div class="text-center mt-5">
                                    <button type="submit" class="btn-premium btn-premium-lg btn-premium-success"
                                        id="saveBtn">
                                        <span id="btnNormal">GUARDAR ALTERAÇÕES</span>
                                        <span id="btnSaving" style="display:none;">
                                            <i class="fas fa-spinner fa-spin"></i> A GUARDAR...
                                        </span>
                                    </button>
                                    <a href="/details/<%= image.id %>"
                                        class="btn-premium btn-premium-lg btn-premium-secondary ml-3">CANCELAR</a>
                                </div>
                            </form>
                        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div>A guardar as alterações...<br><small>Por favor, não feche a página</small></div>
    </div>

    <footer class="mt-5 py-4 text-center bg-light">
        <p class="mb-0">FLORA LUSITANA - © 2025 IVAAP_2 - V. 6.9.8</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = $('#editForm');
        const overlay = $('#loadingOverlay');
        const saveBtn = $('#saveBtn');
        const btnNormal = $('#btnNormal');
        const btnSaving = $('#btnSaving');

        form.on('submit', function (e) {
            // Mostra overlay e muda botão imediatamente
            overlay.show();
            btnNormal.hide();
            btnSaving.show();
            saveBtn.prop('disabled', true);

            // Previne múltiplos submits
            form.off('submit');
        });
    </script>
</body>

</html>