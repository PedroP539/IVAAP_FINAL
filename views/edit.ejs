<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVAAP - Editar Planta</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {background:linear-gradient(135deg,#e8f5e9,#c8e6c9);font-family:'Quicksand',sans-serif;min-height:100vh;display:flex;flex-direction:column}
        .sticky-nav{position:fixed;top:0;width:100%;z-index:1000;background:white}
        .content{padding:2rem 0;flex:1}
        .edit-card{background:white;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:2.5rem;overflow:hidden}
        .preview-img{max-width:100%;max-height:250px;border-radius:15px;box-shadow:0 8px 25px rgba(0,0,0,.2);margin:1rem 0;display:block;transition:opacity .4s}
        .form-control, .form-check-input{border-radius:12px}
        .form-group label{font-weight:bold;color:#27ae60}
        .btn-save{background:linear-gradient(135deg,#27ae60,#2ecc71);border:none;padding:1rem 2.5rem;font-size:1.1rem;border-radius:50px;transition:.3s}
        .btn-save:hover{transform:scale(1.05)}
        .btn-cancel{background:#95a5a6;border:none;padding:1rem 2.5rem;font-size:1.1rem;border-radius:50px}
        .drop-zone{border:3px dashed #27ae60;border-radius:20px;padding:2rem;text-align:center;background:#f8fff8;transition:all .3s;cursor:pointer;margin-bottom:1rem;height:300px;display:flex;flex-direction:column;justify-content:center}
        .drop-zone.dragover{background:#e8f5e9;border-color:#2ecc71}
        .url-input-group{position:relative;margin-top:1rem}
        .url-input{border-radius:50px!important;padding-right:60px}
        .btn-fetch {
            position: absolute;
            right: 0px;
            top: 50%;
            transform: translateY(-50%);
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
        }
        .btn-fetch:hover{background:#219653}
        .marca-section{background:#f0f8f0;border-radius:15px;padding:1.5rem;margin-bottom:1.5rem;border:1px solid #d0e8d2}
        .marca-title{font-weight:bold;color:#27ae60;font-size:1.4rem;margin-bottom:1rem;text-align:center}
        .alert-cors{background:#fff3cd;color:#856404;padding:0.8rem;border-radius:12px;margin:0.5rem 0;display:none}
        textarea {min-height: 200px;}
        @media (max-width: 768px) {
            .marca-section {margin-bottom:2rem;}
        }
    </style>
</head>
<body>
<header class="fixed-top">
    <div class="bg-success text-white text-center py-3">
        <% if (user) { %>
            <strong>Olá <%= user.nome %> <%= user.apelido || '' %></strong>
            — último login: <%= new Date().toLocaleString('pt-PT', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) %>
        <% } else { %>
            <strong>Bem-vindo ao IVAAP</strong>
        <% } %>
    </div>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <a class="navbar-brand font-weight-bold" href="/">IVAAP</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item"><a class="nav-link" href="/upload"><i class="fa-solid fa-upload"></i> CARREGAR</a></li>
                <li class="nav-item"><a class="nav-link" href="/review"><i class="fa-solid fa-pencil"></i> REVER</a></li>
                <li class="nav-item"><a class="nav-link" href="/approved"><i class="fa-solid fa-thumbs-up"></i> APROVADAS</a></li>
                <li class="nav-item"><a class="nav-link" href="/rejected"><i class="fa-solid fa-thumbs-down"></i> REJEITADAS</a></li>
                <li class="nav-item"><a class="nav-link" href="/statistics"><i class="fa-solid fa-bolt"></i> ESTATÍSTICAS</a></li>
                <li class="nav-item"><a class="nav-link" href="/logout"><i class="fa-solid fa-right-from-bracket"></i> SAIR</a></li>
            </ul>
        </div>
    </nav>
</header>
<br><br><br><br>
<main class="container content">
    <div class="text-center mb-4">
        <h2 style="color:#27ae60;font-weight:bold">EDITAR PLANTA</h2>
    </div>
    <% if (error) { %>
        <div class="alert alert-danger text-center"><%= error %></div>
    <% } %>
    <% if (success) { %>
        <div class="alert alert-success text-center"><%= success %></div>
    <% } %>
    <div class="edit-card">
        <form action="/edit" method="POST" enctype="multipart/form-data" id="editForm">
            <div class="row">
                <% const marcasFixas = ['IMAGEM 1', 'IMAGEM 2', 'IMAGEM 3']; %>
                <% for(let index = 0; index < 3; index++) { %>
                    <% const img = relatedImages[index] || null; %>
                    <div class="col-md-4">
                        <div class="marca-section">
                            <h4 class="marca-title"><%= marcasFixas[index] %></h4>
                            <div class="drop-zone" id="dropZone<%= index %>">
                                <i class="fas fa-cloud-upload-alt fa-4x text-success mb-3"></i>
                                <p><strong>Arraste ou clique para <%= img ? 'trocar' : 'adicionar' %></strong></p>
                                <input type="file" name="newImage<%= index %>" id="newImageInput<%= index %>" accept="image/*" style="display:none">
                                <button type="button" class="btn btn-success rounded-pill px-4 mt-2" onclick="document.getElementById('newImageInput<%= index %>').click()">
                                    <%= img ? 'TROCAR LOCAL' : 'ADICIONAR LOCAL' %>
                                </button>
                            </div>
                            <div class="url-input-group">
                                <input type="url" id="newImageUrl<%= index %>" class="form-control url-input" placeholder="Ou nova URL" />
                                <button type="button" class="btn btn-fetch" id="fetchBtn<%= index %>">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                            </div>
                            <div class="alert alert-cors text-center" id="corsAlert<%= index %>">Erro ao carregar URL. Usa local.</div>
                            <% if (img) { %>
                                <img id="preview<%= index %>" src="/uploads/<%= img.image_url %>" class="preview-img" alt="Imagem atual" onerror="this.src='/images/placeholder.jpg'">
                                <input type="hidden" name="imageId<%= index %>" value="<%= img.id %>">
                            <% } else { %>
                                <img id="preview<%= index %>" src="/images/placeholder.jpg" class="preview-img" alt="Sem imagem" style="opacity:0.4">
                            <% } %>
                            <input type="hidden" name="imageFromUrl<%= index %>" id="imageFromUrl<%= index %>" value="">
                        </div>
                    </div>
                <% } %>
            </div>
            <hr class="my-5">
            <!-- CAMPO GAMA -->
            <div class="form-group">
                <label>Gama</label>
                <select name="gama_id" class="form-control">
                    <option value="">Nenhuma / Remover</option>
                    <% gamas.forEach(gama => { %>
                        <option value="<%= gama.id %>" <%= image.gama_id == gama.id ? 'selected' : '' %>><%= gama.nome %></option>
                    <% }); %>
                </select>
            </div>
            <!-- RESTO DOS CAMPOS -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Espécie *</label>
                        <input type="text" name="species" class="form-control" value="<%= image.species %>" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Variedade</label>
                        <input type="text" name="variety" class="form-control" value="<%= image.variety || '' %>">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Nome Botânico</label>
                <input type="text" name="botanical_name" class="form-control" value="<%= image.botanical_name || '' %>">
            </div>
            <div class="row">
                <div class="col-md-6"><div class="form-group"><label>Origem</label><input type="text" name="origem" class="form-control" value="<%= image.origem || '' %>"></div></div>
                <div class="col-md-6"><div class="form-group"><label>Colheita/Floração</label><input type="text" name="colheitaFloracao" class="form-control" value="<%= image.colheitaFloracao || '' %>"></div></div>
            </div>
            <div class="row">
                <div class="col-md-6"><div class="form-group"><label>Exposição Solar</label><input type="text" name="exposicaoSolar" class="form-control" value="<%= image.exposicaoSolar || '' %>"></div></div>
                <div class="col-md-6"><div class="form-group"><label>Rega</label><input type="text" name="rega" class="form-control" value="<%= image.rega || '' %>"></div></div>
            </div>
            <div class="form-group"><label>Profundidade Sementeira</label><input type="text" name="profundidadeSementeira" class="form-control" value="<%= image.profundidadeSementeira || '' %>"></div>
            <div class="form-group"><label>Sementeira Direta</label><div class="form-check"><input class="form-check-input" type="checkbox" name="sementeiraDireta" <%= image.sementeiraDireta ? 'checked' : '' %>><label class="form-check-label">Sim</label></div></div>
            <div class="form-group"><label>Sementeira Alfobre</label><div class="form-check"><input class="form-check-input" type="checkbox" name="sementeiraAlfobre" <%= image.sementeiraAlfobre ? 'checked' : '' %>><label class="form-check-label">Sim</label></div></div>
            <div class="row">
                <div class="col-md-6"><div class="form-group"><label>Sementeira (mês)</label><input type="text" name="sementeira" class="form-control" value="<%= image.sementeira || '' %>"></div></div>
                <div class="col-md-6"><div class="form-group"><label>Transplante (mês)</label><input type="text" name="transplante" class="form-control" value="<%= image.transplante || '' %>"></div></div>
            </div>
            <div class="form-group"><label>Compasso</label><input type="text" name="compasso" class="form-control" value="<%= image.compasso || '' %>"></div>
            <div class="form-group"><label>Características</label><textarea name="caracteristicas" class="form-control" rows="3"><%= image.caracteristicas || '' %></textarea></div>
            <div class="form-group"><label>Conselhos de Cultivo</label><textarea name="conselhos_de_cultivo" class="form-control" rows="4"><%= image.conselhos_de_cultivo || '' %></textarea></div>
            <div class="form-group"><label>Comentários</label><textarea name="comentarios" class="form-control" rows="3"><%= image.comentarios || '' %></textarea></div>
            <div class="text-center mt-5">
                <button type="submit" class="btn btn-save text-white">GUARDAR ALTERAÇÕES</button>
                <a href="/details/<%= image.id %>" class="btn btn-cancel text-white ml-3">CANCELAR</a>
            </div>
        </form>
    </div>
</main>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    for(let index = 0; index < 3; index++) {
        const dropZone = document.getElementById('dropZone' + index);
        const input = document.getElementById('newImageInput' + index);
        const preview = document.getElementById('preview' + index);
        const urlInput = document.getElementById('newImageUrl' + index);
        const fetchBtn = document.getElementById('fetchBtn' + index);
        const corsAlert = document.getElementById('corsAlert' + index);
        const hiddenUrl = document.getElementById('imageFromUrl' + index);

        if (dropZone) {
            ['dragover', 'dragenter'].forEach(evt => dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('dragover'); }));
            ['dragleave', 'dragend'].forEach(evt => dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('dragover'); }));
            dropZone.addEventListener('drop', e => {
                e.preventDefault(); dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    handleFile(e.dataTransfer.files[0]);
                    urlInput.value = ''; hiddenUrl.value = '';
                }
            });
        }

        if (input) {
            input.addEventListener('change', e => {
                if (e.target.files.length) {
                    handleFile(e.target.files[0]);
                    urlInput.value = ''; hiddenUrl.value = '';
                }
            });
        }

        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    corsAlert.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        if (fetchBtn) {
            fetchBtn.addEventListener('click', () => fetchUrl());
            urlInput.addEventListener('keypress', e => { if (e.key === 'Enter') fetchUrl(); });
        }

        function fetchUrl() {
            const url = urlInput.value.trim();
            if (!url) return;
            corsAlert.style.display = 'none';
            preview.style.opacity = 0.5;
            const proxyUrl = '/proxy?url=' + encodeURIComponent(url);
            preview.src = proxyUrl;
            preview.style.opacity = 1;
            hiddenUrl.value = url;
            input.value = '';
            preview.onerror = () => {
                preview.style.opacity = 1;
                corsAlert.style.display = 'block';
                hiddenUrl.value = '';
                preview.src = '/images/placeholder.jpg';
            };
        }
    }
</script>
</body>
</html>