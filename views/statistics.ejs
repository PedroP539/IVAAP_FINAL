<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVAAP - Estatísticas</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            font-family: 'Manrope', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: subpixel-antialiased;
        }

        .content {
            padding: 2rem 0;
            flex: 1
        }

        .sticky-nav {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: white
        }

        .stats-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            transition: transform .2s
        }

        .stats-card:hover {
            transform: translateY(-5px)
        }

        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 0.5rem
        }

        .stats-card .stat-number {
            font-size: 3.2rem;
            font-weight: bold;
            color: #27ae60;
            line-height: 1
        }

        .stats-card p {
            margin: 0.5rem 0 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #27ae60;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem
        }

        .activity-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            padding: 1.8rem;
            margin-bottom: 1.5rem;
            min-height: 330px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee
        }

        .activity-item:last-child {
            border: none
        }

        .activity-thumb {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 12px;
            background: #f0f0f0;
            cursor: pointer;
            transition: transform .2s
        }

        .activity-thumb:hover {
            transform: scale(1.1)
        }

        .activity-text {
            flex: 1
        }

        .activity-label {
            font-size: 0.9rem;
            color: #666
        }

        .activity-value {
            font-weight: bold;
            color: #27ae60
        }

        .activity-value a {
            color: #27ae60;
            text-decoration: none;
            transition: color .2s
        }

        .activity-value a:hover {
            color: #1e8449;
            text-decoration: underline
        }

        .latest-thumb {
            width: 130px;
            height: 130px;
            object-fit: cover;
            border-radius: 12px;
            background: #f0f0f0;
            cursor: pointer;
            transition: transform .2s
        }

        .latest-thumb:hover {
            transform: scale(1.1)
        }

        .progress {
            height: 40px;
            border-radius: 50px;
            background: #e9ecef;
            overflow: hidden
        }

        .progress-bar {
            background: #27ae60;
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 1.5s ease
        }

        .quote-card {
            background: linear-gradient(135deg, #1e8449, #27ae60);
            color: white;
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            min-height: 90%
        }

        .quote-card::before {
            content: '“';
            font-size: 10rem;
            position: absolute;
            top: -30px;
            left: 15px;
            opacity: .15
        }

        .quote-text {
            font-size: 1.5rem;
            font-style: italic;
            line-height: 1.6;
            transition: opacity .8s ease-in-out
        }

        .quote-author {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: right;
            margin-top: 1rem;
            opacity: 0.9;
            position: absolute;
            bottom: 15px;
            right: 30px;
            font-style: italic
        }

        .main-carousel-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            background: #fff;
            height: 100%;
        }

        .main-carousel-container .carousel-item {
            height: 330px;
        }

        .main-carousel-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-caption-custom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            color: white;
            padding: 20px;
            text-align: left;
        }

        .carousel-caption-custom h5 {
            margin: 0;
            font-weight: bold;
            font-size: 1.2rem;
            color: white !important;
        }

        .carousel-caption-custom p {
            margin: 5px 0 0;
            font-size: 0.9rem;
            color: #ccc !important;
        }

        .champion-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            padding: 2rem;
            text-align: center;
            transition: transform .3s
        }

        .champion-card:hover {
            transform: translateY(-8px)
        }

        .champion-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #27ae60;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0 auto 1rem
        }

        .champion-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #27ae60;
            margin: 0.5rem 0
        }

        .champion-count {
            font-size: 3rem;
            font-weight: bold;
            color: #1e8449;
            margin: 0.5rem 0
        }

        .champion-label {
            font-size: 1rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .vote-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .15);
            padding: 1.8rem;
            transition: transform .3s;
            overflow: hidden
        }

        .vote-card:hover {
            transform: translateY(-8px)
        }

        .vote-thumb {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 12px;
            background: #f0f0f0;
            cursor: pointer;
            transition: transform .2s
        }

        .vote-thumb:hover {
            transform: scale(1.05)
        }

        .vote-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #27ae60;
            margin: 1rem 0 0.5rem
        }

        .vote-info {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.5
        }

        .vote-count {
            font-size: 2.2rem;
            font-weight: bold;
            color: #1e8449;
            margin: 0.5rem 0
        }

        .vote-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #27ae60;
            font-weight: bold
        }

        .btn-success {
            color: #fff;
            background-color: #28a745;
            border-color: #28a745;
            font-size: 1rem !important;
        }

        .btn-outline-danger {
            color: #fff;
            background-color: #ff0000;
            border-color: #ff0000;
            padding: 10px 20px !important;
            font-size: 1rem !important;
        }

        .especie {
            font-size: 1.65rem;
            background: #27AE60;
            background: repeating-linear-gradient(to top right, #27AE60 0%, #1C8247 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .variedade {
            font-size: 1.25rem;
            color: #1c8247 !important;
            font-weight: 300 !important;
        }

        .form-control-lg {
            font-size: 1rem !important;
        }

        input#searchQuery,
        input#searchDate,
        input#searchUser,
        button.btn.btn-success.btn-lg.rounded-pill.w-100.h-100.d-flex.align-items-center.justify-content-center {
            font-size: 1rem;
        }
    </style>
</head>

<body>
    <header class="fixed-top">
        <!-- GREEN TOP BAR WITH USER NAME AND LOGIN TIME -->
        <div class="bg-success text-white text-center py-3">
            <% if (user) { %>
                <strong>Olá <%= user.nome %>
                        <%= user.apelido || '' %></strong>
                — último login: <%= new Date().toLocaleString('pt-PT', {day:'2-digit', month:'2-digit', year:'numeric',
                    hour:'2-digit', minute:'2-digit'}) %>
                    <% } else { %>
                        <strong>Bem-vindo ao IVAAP</strong>
                        <% } %>
        </div>
        <!-- MAIN NAVBAR -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
            <a class="navbar-brand font-weight-bold" href="/">IVAAP</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item"><a class="nav-link" href="/upload"><i class="fa-solid fa-upload"></i>
                            CARREGAR</a></li>
                    <li class="nav-item"><a class="nav-link" href="/review"><i class="fa-solid fa-pencil"></i> REVER</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/approved"><i class="fa-solid fa-thumbs-up"></i>
                            APROVADAS</a></li>
                    <li class="nav-item"><a class="nav-link" href="/rejected"><i class="fa-solid fa-thumbs-down"></i>
                            REJEITADAS</a></li>
                    <li class="nav-item"><a class="nav-link" href="/statistics"><i class="fa-solid fa-bolt"></i>
                            ESTATÍSTICAS</a></li>
                    <li class="nav-item"><a class="nav-link" href="/logout"><i
                                class="fa-solid fa-right-from-bracket"></i> SAIR</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <br><br><br><br>

    <!-- BARRA DE BUSCA -->
    <div class="container mt-4 mb-3">
        <div class="card border-0 shadow-sm search-box-container">
            <div class="card-body p-4">
                <form id="searchForm" action="/search" method="GET" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="searchQuery" class="form-label text-success font-weight-bold">Nome da Planta</label>
                        <input type="text" class="form-control form-control-lg rounded-pill" id="searchQuery" name="q"
                            placeholder="Ex: Tomate, Rosa..." value="">
                    </div>
                    <div class="col-md-3">
                        <label for="searchDate" class="form-label text-success font-weight-bold">Data</label>
                        <input type="date" class="form-control form-control-lg rounded-pill" id="searchDate" name="date"
                            value="">
                    </div>
                    <div class="col-md-3">
                        <label for="searchUser" class="form-label text-success font-weight-bold">Utilizador</label>
                        <input type="text" class="form-control form-control-lg rounded-pill" id="searchUser" name="user"
                            placeholder="Ex: admin" value="">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn-premium btn-premium-success w-100 h-100">Pesquisar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <main class="container content">
        <% if (isAdmin) { %>
            <h2 class="text-center mb-4" style="color:#27ae60;font-weight:bold">ESTATÍSTICAS GERAIS (ADMIN)</h2>
            <% } else { %>
                <h2 class="text-center mb-4" style="color:#27ae60;font-weight:bold">AS TUAS ESTATÍSTICAS</h2>
                <% } %>

                    <% if (success) { %>
                        <div class="alert alert-success text-center alert-dismissible fade show">
                            <strong>
                                <%= success %>
                            </strong>
                            <button type="button" class="close" data-dismiss="alert">×</button>
                        </div>
                        <% } %>

                            <!-- 4 CARTÕES PRINCIPAIS COM LINKS CORRETOS -->
                            <div class="row justify-content-center mb-5">
                                <!-- TOTAL CARREGADAS / TUAS IMAGENS -->
                                <div class="col-6 col-md-3">
                                    <a href="/search?user=<%= encodeURIComponent(user.username) %>"
                                        class="text-decoration-none">
                                        <div class="stats-card">
                                            <i class="fa-solid fa-check fa-lg" style="color: #ff9407;"></i><br><br>
                                            <div class="stat-number">
                                                <%= isAdmin ? stats.total : userStats.totalUploaded %>
                                            </div>
                                            <p>
                                                <%= isAdmin ? 'Total Carregadas' : 'Imagens Carregadas' %>
                                            </p>
                                        </div>
                                    </a>
                                </div>

                                <!-- APROVADAS / TUAS APROVAÇÕES -->
                                <div class="col-6 col-md-3">
                                    <a href="/approved?reviewed_by=<%= encodeURIComponent(user.username) %>"
                                        class="text-decoration-none">
                                        <div class="stats-card">
                                            <i class="fa-solid fa-thumbs-up fa-2x text-success"></i><br>
                                            <div class="stat-number">
                                                <%= isAdmin ? stats.approved : userStats.approvedByUser %>
                                            </div>
                                            <p>
                                                <%= isAdmin ? 'Aprovadas (Global)' : 'Tuas Aprovações' %>
                                            </p>
                                        </div>
                                    </a>
                                </div>

                                <!-- REJEITADAS / TUAS REJEIÇÕES -->
                                <div class="col-6 col-md-3">
                                    <a href="/rejected?reviewed_by=<%= encodeURIComponent(user.username) %>"
                                        class="text-decoration-none">
                                        <div class="stats-card">
                                            <i class="fa-solid fa-thumbs-down fa-2x text-danger"></i><br>
                                            <div class="stat-number">
                                                <%= isAdmin ? stats.rejected : userStats.rejectedByUser %>
                                            </div>
                                            <p>
                                                <%= isAdmin ? 'Rejeitadas (Global)' : 'Tuas Rejeições' %>
                                            </p>
                                        </div>
                                    </a>
                                </div>

                                <!-- IMAGENS PENDENTES (agora do utilizador) -->
                                <div class="col-6 col-md-3">
                                    <a href="/review?uploaded_by=<%= encodeURIComponent(user.username) %>"
                                        class="text-decoration-none">
                                        <div class="stats-card">
                                            <i class="fa-solid fa-hourglass-end fa-lg"
                                                style="color: #dedede;"></i><br><br>
                                            <div class="stat-number">
                                                <%= userPendingCount %>
                                            </div>
                                            <p>Tuas Pendentes</p>
                                        </div>
                                    </a>
                                </div>
                            </div>

                            <!-- USER INFO + ÚLTIMA ATIVIDADE GLOBAL -->
                            <div class="row mb-4">
                                <div class="col-lg-4">
                                    <div class="activity-card text-center">
                                        <div class="user-avatar">
                                            <%= user.username.charAt(0).toUpperCase() %>
                                        </div>
                                        <h5><strong>
                                                <%= user.username %>
                                            </strong></h5>
                                        <p class="text-muted small">ÚLTIMO LOGIN:<br>
                                            <%= new Date().toLocaleString('pt-PT') %>
                                        </p>
                                        <p class="text-muted small">ENDEREÇO IP:<br><strong>
                                                <%= clientIP %>
                                            </strong></p>
                                    </div>
                                </div>

                                <div class="col-lg-8">
                                    <div class="main-carousel-container">
                                        <% if (typeof pendingForCarousel !=='undefined' && pendingForCarousel &&
                                            pendingForCarousel.length> 0) { %>
                                            <div id="latestPendingCarousel" class="carousel slide h-100"
                                                data-ride="carousel">
                                                <ol class="carousel-indicators">
                                                    <% pendingForCarousel.forEach((img, i)=> { %>
                                                        <li data-target="#latestPendingCarousel"
                                                            data-slide-to="<%= i %>"
                                                            class="<%= i === 0 ? 'active' : '' %>"></li>
                                                        <% }); %>
                                                </ol>
                                                <div class="carousel-inner h-100">
                                                    <% pendingForCarousel.forEach((img, i)=> { %>
                                                        <div class="carousel-item h-100 <%= i === 0 ? 'active' : '' %>">
                                                            <a href="/review">
                                                                <img src="/uploads/<%= img.image_url %>"
                                                                    class="d-block w-100" alt="<%= img.species %>"
                                                                    onerror="this.src='/images/placeholder.jpg'">
                                                                <div class="carousel-caption-custom">
                                                                    <h5>
                                                                        <%= img.species %>
                                                                            <%= img.variety || '' %>
                                                                    </h5>
                                                                    <p>Pendente para revisão • Por <%= img.uploaded_by
                                                                            %>
                                                                    </p>
                                                                </div>
                                                            </a>
                                                        </div>
                                                        <% }); %>
                                                </div>
                                                <a class="carousel-control-prev" href="#latestPendingCarousel"
                                                    role="button" data-slide="prev">
                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                    <span class="sr-only">Anterior</span>
                                                </a>
                                                <a class="carousel-control-next" href="#latestPendingCarousel"
                                                    role="button" data-slide="next">
                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                    <span class="sr-only">Seguinte</span>
                                                </a>
                                            </div>
                                            <% } else { %>
                                                <div
                                                    class="d-flex flex-column align-items-center justify-content-center h-100 text-muted p-5">
                                                    <i class="fa-solid fa-check-circle fa-4x text-success mb-3"></i>
                                                    <h5>Tudo em dia!</h5>
                                                    <p>Nenhuma imagem pendente para revisão.</p>
                                                </div>
                                                <% } %>
                                    </div>
                                </div>
                            </div>

                            <!-- ÚLTIMA ATIVIDADE GLOBAL DETALHADA -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="activity-card" style="min-height: auto;">
                                        <h5 class="mb-4 text-center">ÚLTIMA ATIVIDADE NA PLATAFORMA</h5>
                                        <div class="row">
                                            <% if (latestImages.uploaded) { %>
                                                <div class="col-md-4">
                                                    <div class="activity-item">
                                                        <a href="/uploads/<%= latestImages.uploaded.image_url %>"
                                                            data-lightbox="stats">
                                                            <img src="/uploads/<%= latestImages.uploaded.image_url %>"
                                                                class="activity-thumb"
                                                                onerror="this.src='/images/placeholder.jpg'">
                                                        </a>
                                                        <div class="activity-text">
                                                            <div class="activity-label"><i
                                                                    class="fa-solid fa-upload text-primary"></i>&nbsp;
                                                                Último
                                                                upload</div>
                                                            <div class="activity-value"><a
                                                                    href="/details/<%= latestImages.uploaded.id %>">
                                                                    <%= latestImages.uploaded.species %>
                                                                        <%= latestImages.uploaded.variety || '' %>
                                                                </a></div>
                                                            <small class="text-muted">
                                                                <%= latestImages.uploaded.uploaded_by %> • <%= new
                                                                        Date(latestImages.uploaded.uploaded_at).toLocaleString('pt-PT')
                                                                        %>
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } %>

                                                    <% if (latestImages.approved) { %>
                                                        <div class="col-md-4">
                                                            <div class="activity-item">
                                                                <a href="/uploads/<%= latestImages.approved.image_url %>"
                                                                    data-lightbox="stats">
                                                                    <img src="/uploads/<%= latestImages.approved.image_url %>"
                                                                        class="activity-thumb"
                                                                        onerror="this.src='/images/placeholder.jpg'">
                                                                </a>
                                                                <div class="activity-text">
                                                                    <div class="activity-label text-success"><i
                                                                            class="fa-solid fa-thumbs-up text-success"></i>&nbsp;
                                                                        Última aprovação</div>
                                                                    <div class="activity-value"><a
                                                                            href="/details/<%= latestImages.approved.id %>">
                                                                            <%= latestImages.approved.species %>
                                                                                <%= latestImages.approved.variety || ''
                                                                                    %>
                                                                        </a></div>
                                                                    <small class="text-muted">por <%=
                                                                            latestImages.approved.reviewed_by %> • <%=
                                                                                new
                                                                                Date(latestImages.approved.reviewed_at).toLocaleString('pt-PT')
                                                                                %></small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% } %>

                                                            <% if (latestImages.rejected) { %>
                                                                <div class="col-md-4">
                                                                    <div class="activity-item">
                                                                        <a href="/uploads/<%= latestImages.rejected.image_url %>"
                                                                            data-lightbox="stats">
                                                                            <img src="/uploads/<%= latestImages.rejected.image_url %>"
                                                                                class="activity-thumb"
                                                                                onerror="this.src='/images/placeholder.jpg'">
                                                                        </a>
                                                                        <div class="activity-text">
                                                                            <div class="activity-label text-danger"><i
                                                                                    class="fa-solid fa-thumbs-down text-danger"></i>&nbsp;
                                                                                Última rejeição</div>
                                                                            <div class="activity-value"><a
                                                                                    href="/details/<%= latestImages.rejected.id %>">
                                                                                    <%= latestImages.rejected.species %>
                                                                                        <%= latestImages.rejected.variety
                                                                                            || '' %>
                                                                                </a></div>
                                                                            <small class="text-muted">por <%=
                                                                                    latestImages.rejected.reviewed_by %>
                                                                                    •
                                                                                    <%= new
                                                                                        Date(latestImages.rejected.reviewed_at).toLocaleString('pt-PT')
                                                                                        %></small>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <% } %>

                                                                    <% if (!latestImages.uploaded &&
                                                                        !latestImages.approved &&
                                                                        !latestImages.rejected) { %>
                                                                        <div class="col-12">
                                                                            <p class="text-center text-muted mb-0">Ainda
                                                                                não há
                                                                                atividade na plataforma.</p>
                                                                        </div>
                                                                        <% } %>
                                        </div>
                                    </div>
                                </div>

                                <!-- NOVAS MÉTRICAS (4 Colunas) -->
                                <div class="row mb-5">
                                    <div class="col-12">
                                        <h4 class="text-center mb-4" style="color:#27ae60;font-weight:bold">TOP IMAGENS
                                        </h4>
                                    </div>

                                    <!-- 1. Global Pending Voted -->
                                    <div class="col-6 col-md-3">
                                        <div class="vote-card text-center" style="min-height:350px">
                                            <div class="vote-label" style="color:#f39c12">EM REVISÃO - MAIS VOTADA</div>
                                            <% if (newMetrics.globalPendingVoted) { %>
                                                <a href="/uploads/<%= newMetrics.globalPendingVoted.image_url %>"
                                                    data-lightbox="stats-new">
                                                    <img src="/uploads/<%= newMetrics.globalPendingVoted.image_url %>"
                                                        class="vote-thumb mb-2"
                                                        onerror="this.src='/images/placeholder.jpg'">
                                                </a>
                                                <div class="text-muted small"><strong>
                                                        <%= newMetrics.globalPendingVoted.approvals %>
                                                    </strong> Aprovações</div>
                                                <a href="/details/<%= newMetrics.globalPendingVoted.id %>"
                                                    class="btn-premium btn-premium-sm btn-premium-warning mt-2">Ver</a>
                                                <% } else { %>
                                                    <p class="text-muted mt-4">Sem dados</p>
                                                    <% } %>
                                        </div>
                                    </div>

                                    <!-- 2. Global Pending Rejected -->
                                    <div class="col-6 col-md-3">
                                        <div class="vote-card text-center" style="min-height:350px">
                                            <div class="vote-label" style="color:#e74c3c">EM REVISÃO - MAIS REJEITADA
                                            </div>
                                            <% if (newMetrics.globalPendingRejected) { %>
                                                <a href="/uploads/<%= newMetrics.globalPendingRejected.image_url %>"
                                                    data-lightbox="stats-new">
                                                    <img src="/uploads/<%= newMetrics.globalPendingRejected.image_url %>"
                                                        class="vote-thumb mb-2"
                                                        onerror="this.src='/images/placeholder.jpg'">
                                                </a>
                                                <div class="text-muted small"><strong>
                                                        <%= newMetrics.globalPendingRejected.rejections %>
                                                    </strong> Rejeições</div>
                                                <a href="/details/<%= newMetrics.globalPendingRejected.id %>"
                                                    class="btn-premium btn-premium-sm btn-premium-danger mt-2">Ver</a>
                                                <% } else { %>
                                                    <p class="text-muted mt-4">Sem dados</p>
                                                    <% } %>
                                        </div>
                                    </div>

                                    <!-- 3. User Most Voted -->
                                    <div class="col-6 col-md-3">
                                        <div class="vote-card text-center" style="min-height:350px">
                                            <div class="vote-label" style="color:#27ae60">TUA - MAIS VOTADA</div>
                                            <% if (newMetrics.userMostVoted) { %>
                                                <a href="/uploads/<%= newMetrics.userMostVoted.image_url %>"
                                                    data-lightbox="stats-new">
                                                    <img src="/uploads/<%= newMetrics.userMostVoted.image_url %>"
                                                        class="vote-thumb mb-2"
                                                        onerror="this.src='/images/placeholder.jpg'">
                                                </a>
                                                <div class="text-muted small"><strong>
                                                        <%= newMetrics.userMostVoted.approvals %>
                                                    </strong> Aprovações</div>
                                                <a href="/details/<%= newMetrics.userMostVoted.id %>"
                                                    class="btn-premium btn-premium-sm btn-premium-success mt-2">Ver</a>
                                                <% } else { %>
                                                    <p class="text-muted mt-4">Sem dados</p>
                                                    <% } %>
                                        </div>
                                    </div>

                                    <!-- 4. User Most Rejected -->
                                    <div class="col-6 col-md-3">
                                        <div class="vote-card text-center" style="min-height:350px">
                                            <div class="vote-label" style="color:#c0392b">TUA - MAIS REJEITADA</div>
                                            <% if (newMetrics.userMostRejected) { %>
                                                <a href="/uploads/<%= newMetrics.userMostRejected.image_url %>"
                                                    data-lightbox="stats-new">
                                                    <img src="/uploads/<%= newMetrics.userMostRejected.image_url %>"
                                                        class="vote-thumb mb-2"
                                                        onerror="this.src='/images/placeholder.jpg'">
                                                </a>
                                                <div class="text-muted small"><strong>
                                                        <%= newMetrics.userMostRejected.rejections %>
                                                    </strong> Rejeições</div>
                                                <a href="/details/<%= newMetrics.userMostRejected.id %>"
                                                    class="btn-premium btn-premium-sm btn-premium-danger mt-2">Ver</a>
                                                <% } else { %>
                                                    <p class="text-muted mt-4">Sem dados</p>
                                                    <% } %>
                                        </div>
                                    </div>
                                </div>

                                <!-- TIMELINE DE ATIVIDADE DO UTILIZADOR -->
                                <div class="row mb-5">
                                    <div class="col-12">
                                        <div class="accordion" id="activityAccordion">
                                            <div class="card border-0 shadow-sm"
                                                style="border-radius: 20px; overflow: hidden;">
                                                <div class="card-header bg-white border-0 p-0" id="headingOne">
                                                    <button
                                                        class="btn btn-block bg-white text-left p-4 text-decoration-none d-flex justify-content-between align-items-center shadow-none"
                                                        style="width: 100%; border-radius: 0;" type="button"
                                                        data-toggle="collapse" data-target="#collapseOne"
                                                        aria-expanded="false" aria-controls="collapseOne">
                                                        <h4 class="mb-0" style="color:#27ae60;font-weight:bold">TIMELINE
                                                            DA
                                                            TUA ATIVIDADE</h4>
                                                        <i class="fas fa-chevron-down text-success"></i>
                                                    </button>
                                                </div>

                                                <div id="collapseOne" class="collapse" aria-labelledby="headingOne"
                                                    data-parent="#activityAccordion">
                                                    <div class="card-body p-4 pt-0">
                                                        <% if (userActivity && userActivity.length> 0) { %>
                                                            <div class="timeline">
                                                                <% userActivity.forEach(activity=> { %>
                                                                    <div
                                                                        class="activity-item d-flex align-items-center mb-3 pb-3 border-bottom">
                                                                        <div class="me-3">
                                                                            <% if (activity.action==='upload' ) { %>
                                                                                <i
                                                                                    class="fa-solid fa-upload fa-2x text-primary"></i>
                                                                                <% } else if
                                                                                    (activity.action==='approve' ) { %>
                                                                                    <i
                                                                                        class="fa-solid fa-thumbs-up fa-2x text-success"></i>
                                                                                    <% } else if
                                                                                        (activity.action==='reject' ) {
                                                                                        %>
                                                                                        <i
                                                                                            class="fa-solid fa-thumbs-down fa-2x text-danger"></i>
                                                                                        <% } %>
                                                                        </div>
                                                                        <div class="flex-grow-1">
                                                                            <strong>
                                                                                <% if (activity.action==='upload' ) { %>
                                                                                    Carregaste<% } %>
                                                                                        <% if
                                                                                            (activity.action==='approve'
                                                                                            ) { %>Aprovaste<% } %>
                                                                                                <% if
                                                                                                    (activity.action==='reject'
                                                                                                    ) { %>Rejeitaste<% }
                                                                                                        %>
                                                                                                        <%= ' ' +
                                                                                                            activity.species
                                                                                                            %>
                                                                                                            <%= activity.variety
                                                                                                                ? '(' +
                                                                                                                activity.variety
                                                                                                                + ')'
                                                                                                                : '' %>
                                                                            </strong>
                                                                            <br>
                                                                            <small class="text-muted">
                                                                                <%= new
                                                                                    Date(activity.timestamp).toLocaleString('pt-PT')
                                                                                    %>
                                                                            </small>
                                                                        </div>
                                                                        <div>
                                                                            <a href="/details/<%= activity.id %>"
                                                                                class="btn-premium btn-premium-sm btn-premium-success">Ver</a>
                                                                        </div>
                                                                    </div>
                                                                    <% }); %>
                                                            </div>
                                                            <% } else { %>
                                                                <p class="text-center text-muted mb-0">Ainda não tens
                                                                    atividade registada.</p>
                                                                <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>



                                <!-- CAMPEÕES DO IVAAP – APENAS PARA ADMIN -->
                                <% if (isAdmin) { %>
                                    <div class="row mb-5">
                                        <div class="col-12">
                                            <h4 class="text-center mb-4" style="color:#27ae60;font-weight:bold">CAMPEÕES
                                                DO
                                                IVAAP</h4>
                                            <div class="row">
                                                <div class="col-6 col-md-3">
                                                    <div class="champion-card">
                                                        <div class="champion-avatar">
                                                            <%= topUsers.uploads?.user?.charAt(0).toUpperCase() || '?'
                                                                %>
                                                        </div>
                                                        <div class="champion-name">
                                                            <%= topUsers.uploads?.user || 'Ninguém' %>
                                                        </div>
                                                        <div class="champion-count">
                                                            <%= topUsers.uploads?.count || 0 %>
                                                        </div>
                                                        <div class="champion-label">Mais Uploads</div>
                                                    </div>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <div class="champion-card">
                                                        <div class="champion-avatar">
                                                            <%= topUsers.approvals?.user?.charAt(0).toUpperCase() || '?'
                                                                %>
                                                        </div>
                                                        <div class="champion-name">
                                                            <%= topUsers.approvals?.user || 'Ninguém' %>
                                                        </div>
                                                        <div class="champion-count">
                                                            <%= topUsers.approvals?.count || 0 %>
                                                        </div>
                                                        <div class="champion-label">Mais Aprovações</div>
                                                    </div>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <div class="champion-card">
                                                        <div class="champion-avatar">
                                                            <%= topUsers.rejections?.user?.charAt(0).toUpperCase()
                                                                || '?' %>
                                                        </div>
                                                        <div class="champion-name">
                                                            <%= topUsers.rejections?.user || 'Ninguém' %>
                                                        </div>
                                                        <div class="champion-count">
                                                            <%= topUsers.rejections?.count || 0 %>
                                                        </div>
                                                        <div class="champion-label">Mais Rejeições</div>
                                                    </div>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <div class="champion-card">
                                                        <div class="champion-avatar">
                                                            <%= topUsers.comments?.user?.charAt(0).toUpperCase() || '?'
                                                                %>
                                                        </div>
                                                        <div class="champion-name">
                                                            <%= topUsers.comments?.user || 'Ninguém' %>
                                                        </div>
                                                        <div class="champion-count">
                                                            <%= topUsers.comments?.count || 0 %>
                                                        </div>
                                                        <div class="champion-label">Mais Comentários</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>



                                        <!-- A TUA ATIVIDADE -->
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <h4 class="text-center mb-4" style="color:#27ae60;font-weight:bold">A
                                                    TUA
                                                    ATIVIDADE</h4>
                                            </div>
                                            <% const ua=latestUser || {}; %>
                                                <div class="col-md-3">
                                                    <div class="activity-card text-center">
                                                        <p><strong>Último Upload</strong></p>
                                                        <% if (ua.uploaded) { %>
                                                            <a href="/uploads/<%= ua.uploaded.image_url %>"
                                                                data-lightbox="stats">
                                                                <img src="/uploads/<%= ua.uploaded.image_url %>"
                                                                    class="latest-thumb mb-2"
                                                                    onerror="this.src='/images/placeholder.jpg'">
                                                            </a>
                                                            <p><a href="/details/<%= ua.uploaded.id %>"
                                                                    style="color:#27ae60;font-weight:bold;text-decoration:none">
                                                                    <%= ua.uploaded.species %><br>
                                                                        <%= ua.uploaded.variety || '' %>
                                                                </a></p>
                                                            <small>
                                                                <%= new
                                                                    Date(ua.uploaded.uploaded_at).toLocaleString('pt-PT')
                                                                    %>
                                                            </small>
                                                            <% } else { %>
                                                                <p class="text-muted">Ainda não carregaste nenhuma
                                                                    imagem
                                                                </p>
                                                                <% } %>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="activity-card text-center">
                                                        <p><strong>Última Aprovação</strong></p>
                                                        <% if (ua.approved) { %>
                                                            <a href="/uploads/<%= ua.approved.image_url %>"
                                                                data-lightbox="stats">
                                                                <img src="/uploads/<%= ua.approved.image_url %>"
                                                                    class="latest-thumb mb-2"
                                                                    onerror="this.src='/images/placeholder.jpg'">
                                                            </a>
                                                            <p><a href="/details/<%= ua.approved.id %>"
                                                                    style="color:#27ae60;font-weight:bold;text-decoration:none">
                                                                    <%= ua.approved.species %><br>
                                                                        <%= ua.approved.variety || '' %>
                                                                </a></p>
                                                            <small>
                                                                <%= new
                                                                    Date(ua.approved.reviewed_at).toLocaleString('pt-PT')
                                                                    %>
                                                            </small>
                                                            <% } else { %>
                                                                <p class="text-muted">Ainda não aprovaste imagens</p>
                                                                <% } %>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="activity-card text-center">
                                                        <p><strong>Última Rejeição</strong></p>
                                                        <% if (ua.rejected) { %>
                                                            <a href="/uploads/<%= ua.rejected.image_url %>"
                                                                data-lightbox="stats">
                                                                <img src="/uploads/<%= ua.rejected.image_url %>"
                                                                    class="latest-thumb mb-2"
                                                                    onerror="this.src='/images/placeholder.jpg'">
                                                            </a>
                                                            <p><a href="/details/<%= ua.rejected.id %>"
                                                                    style="color:#27ae60;font-weight:bold;text-decoration:none">
                                                                    <%= ua.rejected.species %><br>
                                                                        <%= ua.rejected.variety || '' %>
                                                                </a></p>
                                                            <small>
                                                                <%= new
                                                                    Date(ua.rejected.reviewed_at).toLocaleString('pt-PT')
                                                                    %>
                                                            </small>
                                                            <% } else { %>
                                                                <p class="text-muted">Ainda não rejeitaste imagens</p>
                                                                <% } %>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="activity-card text-center">
                                                        <p><strong>Último Pendente</strong></p>
                                                        <% if (ua.pending) { %>
                                                            <a href="/uploads/<%= ua.pending.image_url %>"
                                                                data-lightbox="stats">
                                                                <img src="/uploads/<%= ua.pending.image_url %>"
                                                                    class="latest-thumb mb-2"
                                                                    onerror="this.src='/images/placeholder.jpg'">
                                                            </a>
                                                            <p><a href="/details/<%= ua.pending.id %>"
                                                                    style="color:#27ae60;font-weight:bold;text-decoration:none">
                                                                    <%= ua.pending.species %><br>
                                                                        <%= ua.pending.variety || '' %>
                                                                </a></p>
                                                            <small>
                                                                <%= new
                                                                    Date(ua.pending.uploaded_at).toLocaleString('pt-PT')
                                                                    %>
                                                            </small>
                                                            <% } else { %>
                                                                <p class="text-muted">Nenhum imagem pendente para tua
                                                                    avaliação</p>
                                                                <% } %>
                                                    </div>
                                                </div>
                                        </div>

                                        <!-- TAXA DE APROVAÇÃO PESSOAL -->
                                        <div class="row">
                                            <div class="col-lg-6">
                                                <div class="stats-card">
                                                    <h3>A Tua Taxa de Aprovação</h3>
                                                    <div class="progress">
                                                        <div class="progress-bar"
                                                            style="width: <%= userStats.userApprovalRate + '%' %>">
                                                            <%= userStats.userApprovalRate %>%
                                                        </div>
                                                    </div>
                                                    <p class="mt-3">
                                                        <%= userStats.approvedByUser %> de <%= userStats.reviewedByUser
                                                                %>
                                                                imagens revistas por ti foram aprovadas
                                                    </p>
                                                    <% if (userStats.reviewedByUser===0) { %>
                                                        <small class="text-muted">Ainda não reviste nenhuma
                                                            imagem</small>
                                                        <% } %>
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="quote-card">
                                                    <div class="quote-text" id="quote-text">Carregando frase épica...
                                                    </div>
                                                    <div class="quote-author" id="quote-author">— IVAAP</div>
                                                </div>
                                            </div>
                                        </div>
    </main>

    <footer class="mt-5 py-4 text-center bg-light">
        <p class="mb-0">FLORA LUSITANA - © 2025 IVAAP_2 - V. 6.9.8</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
    <script src="/js/quotes.js"></script>
    <script>
        setTimeout(() => $('.alert').fadeOut(1000), 5000);
        lightbox.option({
            resizeDuration: 300,
            wrapAround: true,
            albumLabel: "Imagem %1 de %2"
        });
        const quoteText = document.getElementById('quote-text');
        const quoteAuthor = document.getElementById('quote-author');
        let currentQuote = 0;
        function showQuote() {
            if (typeof quotes !== 'undefined' && quotes.length > 0) {
                quoteText.style.opacity = 0;
                quoteAuthor.style.opacity = 0;
                setTimeout(() => {
                    quoteText.textContent = quotes[currentQuote].text;
                    quoteAuthor.textContent = quotes[currentQuote].author;
                    quoteText.style.opacity = 1;
                    quoteAuthor.style.opacity = 1;
                    currentQuote = (currentQuote + 1) % quotes.length;
                }, 400);
            }
        }
        showQuote();
        setInterval(showQuote, 4000);
        setTimeout(() => {
            document.querySelector('.progress-bar').style.width = '<%= userStats.userApprovalRate %>%';
        }, 500);
    </script>
</body>

</html>